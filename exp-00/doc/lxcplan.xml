<?xml version="1.0" encoding="UTF-8"?>
<lxcplan>

  <containertemplates>
    <containertemplate name="node">
      <parameters>
        <parameter name="lxc.tty" value="1"/>
        <parameter name="lxc.pts" value="128"/>
        <parameter name="lxc.console" value="none"/>
        <parameter name="lxc.mount.auto" value="proc sys"/>
      </parameters>

      <interfaces>
        <interface bridge="br.ctl" hosts_entry_ipv4="${lxc_name}">
          <parameter name="lxc.network.type" value="veth"/>
          <parameter name="lxc.network.name" value="backchan0"/>
          <parameter name="lxc.network.flags" value="up"/>
          <parameter name="lxc.network.hwaddr" value="02:00:${'%02x' % lxc_index}:01:00:${'%02x' % lxc_index}"/>
          <parameter name="lxc.network.ipv4" value="10.99.0.${lxc_index}/16"/>
          <parameter name="lxc.network.veth.pair" value="veth.ctl.${lxc_index}"/>
        </interface>

        <interface bridge="br.ota">
          <parameter name="lxc.network.type" value="veth"/>
          <parameter name="lxc.network.name" value="ota0"/>
          <parameter name="lxc.network.flags" value="up"/>
          <parameter name="lxc.network.hwaddr" value="02:00:${'%02x' % lxc_index}:02:00:${'%02x' % lxc_index}"/>
          <parameter name="lxc.network.ipv4" value="10.98.0.${lxc_index}/16"/>
          <parameter name="lxc.network.veth.pair" value="veth.ota.${lxc_index}"/>
        </interface>

      </interfaces>

      <initscript>

        #!/bin/bash -

        <%
        import re
        net_devs = set()
        for key in context.keys():
            if re.match(r'lxc.interface\.(\d+)\.name', key) and context[key] != 'lo':
                net_devs.add(context[key])
        %>

        # This function is modified to use a generic sshd config file, not the system config
        start_sshd()
        {
            local pidfile=$1
            local sshConfig=$2

            /usr/sbin/sshd -o "PidFile=$pidfile" -f $sshConfig
        }

        export PATH=$PATH:/sbin:/usr/sbin:/usr/local/bin:/usr/local/sbin

        top_dir=$1
        node=$2
        env=$3
        start_utc=$4

        # fix devpts
        mount /dev/pts -o remount,rw,mode=620,ptmxmode=666,gid=5

        # turn on forwarding
        sysctl net.ipv4.ip_forward=1

        # disable tx and rx checksum offloading
        % for net_dev in net_devs:
        ethtool --offload  ${net_dev} rx off tx off
        % endfor

        # source an environment (if provided)
        if [ -n "$env" ]
        then
            . $env
        fi

        # start sshd
        start_sshd $top_dir/persist/$node/var/run/ssh.pid $top_dir/../templates/common/sshd_config_lxc

        # run a local init if provided
        if [ -f $top_dir/$node/init.local ]
        then
            bash $top_dir/$node/init.local "$top_dir" "$node" "$start_utc" \
                2>&1 | tee  $top_dir/persist/$node/var/log/init.log
        fi
      </initscript>

    </containertemplate>
  </containertemplates>

  <hosts>
    <host hostname="localhost">
      <bridges>
        <bridge name="br.ctl">
          <ipaddress>
            <ipv4>10.99.0.100/16</ipv4>
          </ipaddress>
        </bridge>

        <bridge name="br.ota">
          <ipaddress>
            <ipv4>10.98.0.100/16</ipv4>
          </ipaddress>
        </bridge>

      </bridges>

      <containers>
        <container lxc_name="helper" lxc_indices="201" template="node"/>
        <container lxc_name="node-bat0" lxc_indices="200" template="node"/>
        <container lxc_name="node-${'%03d' % lxc_index}" lxc_indices="1-3,254" template="node"/>
      </containers>
    </host>
  </hosts>
</lxcplan>